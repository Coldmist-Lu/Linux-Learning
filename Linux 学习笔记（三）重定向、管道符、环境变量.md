# Linux 学习笔记（三）重定向、管道符、环境变量

* 本笔记基于 刘遄 的《Linux 就该这么学》一书。
* 本章将首先介绍与文件读写操作有关的重定向技术，然后讲解管道命令符、通配符、转义符等，最后介绍 Linux 执行命令的内部原理，以及 Path 变量和环境变量。



## 输入输出重定向

### 引言

* 简单来说，输入重定向是指把**文件导入命令**中，而输出重定向是指把原本要输出到**屏幕**的数据信息**写入到指定文件**中。
* 相较于输入重定向，输出重定向的使用频率更高，
  * 因此输出重定向有分为**标准输出重定向**、**错误输出重定向**两种不同技术；
  * 以及**清空写入**与**追加写入**两种模式。



### 不同的输入输出信息

#### 定义

* 标准输入重定向 STDIN：文件描述符为 0，默认从键盘输入，也可从其他文件或命令中输入。
* 标准输出重定向 STDOUT：文件描述符为 1，默认输出到屏幕。
* 错误输出重定向 STDERR：文件描述符为 2，默认输出到屏幕。

#### 不同的输出信息

* 以 ls 为例，展示一个输出正确信息和错误信息的例子：

```shell
touch linuxprobe
ls -l linuxprobe
ls -l xxxxxx
```

![1](Linux_3_pic/1.png)

* 上述命令中，由于名为 linuxprobe 的文件存在，输出信息是该文件的一些相关权限、所有者、所属组、文件大小及修改时间等信息，这也是该命令的**标准输出信息**；而名为 xxxxxx 的文件是不存在的，因此显示了报错信息（即错误输出信息）。



### 重定向技术符号

#### 输入重定向符号

* 输入重定向技术用到的符号和作用：

| 符号                 | 作用                                            |
| -------------------- | ----------------------------------------------- |
| 命令 < 文件          | 将文件作为命令的标准输入                        |
| 命令 << 分界符       | 从标准输入中读入，直到遇见分界符才停止          |
| 命令 < 文件1 > 文件2 | 将文件 1 作为命令的标准输入并将标准输出到文件 2 |

#### 输出重定向符号

* 输出重定向技术用到的符号和作用：

| 符号              | 作用                                                         |
| ----------------- | ------------------------------------------------------------ |
| 命令 > 文件       | 将标准输出重定向到一个文件中（清空原有文件的数据）           |
| 命令 2> 文件      | 将错误输出重定向到一个文件中（清空原有文件的数据）           |
| 命令 >> 文件      | 将标准输出重定向到一个文件中（追加到原有内容的后面）         |
| 命令 2>> 文件     | 将错误输出重定向到一个文件中（追加到原有内容的后面）         |
| 命令 >> 文件 2>&1 | 将标准输出与错误输出共同写入到文件中（追加到原有内容的后面） |
| 命令 &>> 文件     | 作用同上                                                     |

* 注意，重定向中的标准输出模式，可以省略文件描述符 1 不写，而错误输出模式的 2 是必须要写的。



### 例子

#### 重定向输出

* 下例将 man bash 命令原本要输出的信息写入到 readme.txt 中：

```shell
man bash > readme.txt
cat readme.txt
```

![2](Linux_3_pic/2.png)

#### 覆盖写、追加写

* 为了展示覆盖写和追加写模式的区别，下面继续对 readme.txt 文件覆盖写入一行信息（覆盖刚刚的 man bash 输出），然后通过追加写入模式向文件写入一次数据：

```shell
echo "Welcome to LinuxProbe.Com" > readme.txt
echo "Quality linux learning materials" >> readme.txt
cat readme.txt
```

![3](Linux_3_pic/3.png)

#### 标准输出重定向

* 对于标准输出，如果进行错误输出重定向，那么结果依然会输出到屏幕上：

```shell
ls -l linuxprobe
ls -l linuxprobe > /root/stderr.txt
ls -l linuxprobe 2> /root/stderr.txt
```

![4](Linux_3_pic/4.png)

#### 错误输出重定向

* 对于错误输出，如果进行正确输出重定向，结果依然会输出到屏幕上：
  * 当用户执行一个自动化的 Shell 脚本时，这个操作非常有用，因为可以把整个脚本执行过程中的报错信息都记录到文件中。

```shell
ls -l xxxxxx
ls -l xxxxxx > /root/stderr.txt
ls -l xxxxxx 2> /root/stderr.txt
cat /root/stderr.txt
```

![5](Linux_3_pic/5.png)

#### 输入重定向

* 输入重定向用的较少一点，把文件直接导入到命令中：

```shell
wc -l readme.txt
```

![6](Linux_3_pic/6.png)

* 该命令等同于接下来学习的 cat readme.txt | wc -l 的管道符命令组合。



## 管道命令符

### 格式与含义

#### 格式

* 管道符 | 可以通过键盘上 Shift+\ 键来输入，其执行格式为 命令 A | 命令 B。

#### 作用

* 管道符的作用是，把**前一个命令**原本要**输出到屏幕**的标准正常数据当做是**后一个命令的标准输入**。



### 实例

#### 连接实例 1：输出+求行数

* 上一章中曾讲解过用于文本搜索的 grep 命令以及用该命令匹配 /etc/passwd 中用户信息中 /sbin/nologin 内容的代码。
  * （ /sbin/nologin 内容说明该用户被限制登录）
  * 这里先稍微复习一下：

```shell
grep /sbin/nologin /etc/passwd
```

* 接下来通过管道符来解决**返回被限制登录的用户数量**的问题：
  * 该问题可以拆解为以下两个部分：
  * 1、用 grep 命令找出被限制登录用户（同刚刚复习的 grep 命令）
  * 2、统计输出内容的行数（wc -l 命令）

* 因此上述问题可以用管道符加以连接：

```shell
grep /sbin/nologin /etc/passwd | wc -l
```

![7](Linux_3_pic/7.png)

#### 连接实例 2：输出+翻页

* 当一个命令的输出过多时，可以通过管道符添加翻页方法：
  * 比如，用翻页的形式查看 /etc 目录中的文件列表及属性信息：

```shell
ls -l /etc/ | more
```

![8](Linux_3_pic/8.png)

#### 连接实例 3：修改密码+确认

* 修改用户密码时，通常都需要输入两次密码以进行确认，这在编写自动化脚本时会成为一个致命缺陷。
  * 通过将管道符和 passwd 命令的 --stdin 参数相结合，来用一个命令完成密码重置工作：

```shell
echo "linuxprobe" | passwd --stdin root
```

![9](Linux_3_pic/9.png)

#### 连接实例 4：邮件打包发送

* 发送邮件默认采用交互式的方式来进行；利用管道符可以实现一条命令将标题和内容打包发送：

```shell
echo "Content" | mail -s "Subject" linuxprobe
su - linuxprobe
```

![10](Linux_3_pic/10.png)

#### 连接实例 5：重定向符做管道

* 管道符还有很多高级的用法，下面一条命令使用 mail 邮件命令和输入重定向让用户一直输入内容，知道 over 结束：

```shell
mail -s "Readme" root@linuxprobe.com << over
```

![11](Linux_3_pic/11.png)



### 总结

* 管道命令符在一个命令组中不是只可以用一次，也完全可以使用：命令 A | 命令 B | 命令 C。
* 管道命令符就好像是"哆啦A梦"里的任意门，多次使用来实现数据穿越，提高了工作效率。



## 命令行的通配符



